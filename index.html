<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO ç®€å•èŠå¤©å®¤</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ------------------ åŸºç¡€è®¾ç½®ä¸å¸ƒå±€ ------------------ */
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Roboto', sans-serif; 
            background-color: #f0f2f5; 
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
            justify-content: center;
            align-items: center;
        }

        /* ------------------ ç™»å½•/è®¤è¯å®¹å™¨ ------------------ */
        #auth-container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 350px;
            text-align: center;
        }
        #auth-container h2 {
            color: #007bff;
            margin-bottom: 25px;
            font-weight: 500;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .auth-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            background-color: #007bff;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .auth-button:hover {
            background-color: #0056b3;
        }
        
        /* ------------------ èŠå¤©åŒºåŸŸ ------------------ */
        #chat-container {
            display: none; 
            flex-direction: column;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin: 15px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            flex-grow: 1;
            max-width: 1000px;
            height: 90vh;
            margin-right: 250px; 
        }

        /* èŠå¤©å¤´éƒ¨è°ƒæ•´ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        #logout-button {
            background: #ff5757;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }
        #logout-button:hover {
            background: #cc4545;
        }

        /* æ¶ˆæ¯åˆ—è¡¨ */
        #messages { 
            list-style-type: none; 
            margin: 0; 
            padding: 20px; 
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* æ¶ˆæ¯é¡¹å®¹å™¨ */
        #messages li { 
            display: flex;
            margin-bottom: 15px;
            clear: both;
        }

        /* æ¶ˆæ¯æ°”æ³¡å†…å®¹åŒº */
        .message-bubble {
            padding: 12px 18px; 
            border-radius: 20px;
            max-width: 65%;
            word-wrap: break-word; 
            font-size: 0.95em;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
            position: relative;
        }

        /* æ¥æ”¶åˆ°çš„æ¶ˆæ¯ (å·¦ä¾§) */
        .other-msg {
            justify-content: flex-start;
        }
        .other-msg .message-bubble {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px; 
        }

        /* æˆ‘å‘é€çš„æ¶ˆæ¯ (å³ä¾§) */
        .my-msg {
            justify-content: flex-end; 
        }
        .my-msg .message-bubble {
            background-color: #dcf8c6; 
            border: 1px solid #c2e7b0;
            border-bottom-right-radius: 5px; 
        }

        /* æ¶ˆæ¯å¤´éƒ¨ */
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .username {
            font-weight: 500;
            color: #007bff; 
            font-size: 0.9em;
        }
        .my-msg .username {
            color: #28a745; 
        }
        .timestamp {
            font-size: 0.7em;
            color: #999;
            margin-left: 10px;
        }

        /* ç³»ç»Ÿæ¶ˆæ¯ */
        .system-msg {
            text-align: center;
            font-style: italic;
            color: #888;
            padding: 10px 0;
            font-size: 0.8em;
        }
        
        /* è¾“å…¥è¡¨å•åŒºåŸŸ */
        #form-container {
            background: #fdfdfd; 
            padding: 15px 20px; 
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        #form {
            display: flex;
            align-items: center;
        }
        #input { 
            border: 1px solid #ced4da; 
            padding: 12px 18px; 
            flex-grow: 1; 
            border-radius: 25px; 
            margin-right: 15px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        #form > button { 
            background: #007bff; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 25px; 
            outline: none; 
            color: #fff;
            cursor: pointer;
        }
        
        /* ä¾§è¾¹æ è°ƒæ•´ */
        #online-users {
            width: 250px; 
            min-width: 250px;
            height: 100vh;
            background: #ffffff;
            border-left: 1px solid #e0e0e0;
            padding: 20px 15px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.08);
            box-sizing: border-box; 
            z-index: 5;
            position: fixed; 
            right: 0; 
            top: 0;
        }
    </style>
</head>
<body>
    
    <div id="auth-container">
        <h2 id="auth-title">è¾“å…¥æ˜µç§°</h2>
        <form id="auth-form">
            <div class="input-group">
                <input type="text" id="username-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" required>
            </div>
            <button type="submit" class="auth-button">è¿›å…¥èŠå¤©å®¤</button>
        </form>
    </div>

    <div id="chat-container" style="display: none;">
        <div class="header">
            <span id="current-user-display">ğŸ’¬ èŠå¤©å®¤ (æœªç™»å½•)</span>
            <button id="logout-button">é€€å‡ºç™»å½•</button>
        </div>
        
        <ul id="messages"></ul>
        
        <div id="form-container">
            <form id="form" action="">
                <input id="input" autocomplete="off" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." />
                <button>å‘é€</button>
            </form>
        </div>
    </div>
    
    <div id="online-users">
        <h4>ğŸŸ¢ åœ¨çº¿ç”¨æˆ· (<span id="user-count">0</span>)</h4>
        <ul id="user-list"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        // ------------------ å˜é‡åˆå§‹åŒ– ------------------
        let socket = null;
        let username = '';
        const LOCAL_CHAT_KEY = 'chat_messages_local'; 
        const USERNAME_KEY = 'chat_username'; 
        
        // è®¤è¯å…ƒç´ 
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username-input');
        
        // èŠå¤©å…ƒç´ 
        const chatContainer = document.getElementById('chat-container');
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const currentUserDisplay = document.getElementById('current-user-display');
        const logoutButton = document.getElementById('logout-button');
        const userList = document.getElementById('user-list');
        const userCountSpan = document.getElementById('user-count');

        // ------------------ æ ¸å¿ƒé€»è¾‘ ------------------
        
        // æ ¼å¼åŒ–æ—¶é—´ (è¾…åŠ©å‡½æ•°)
        function formatTime(date) {
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            const s = date.getSeconds().toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // ä¿å­˜æ¶ˆæ¯åˆ° localStorage
        function saveMessageToLocal(msgData) {
            let currentMessages = JSON.parse(localStorage.getItem(LOCAL_CHAT_KEY)) || [];
            currentMessages.push({
                user: msgData.user, 
                text: msgData.text,
                timestamp: msgData.timestamp || new Date().toISOString(),
            });
            localStorage.setItem(LOCAL_CHAT_KEY, JSON.stringify(currentMessages));
        }

        // ä» localStorage åŠ è½½æ¶ˆæ¯
        function loadMessagesFromLocal() {
            messages.innerHTML = ''; 
            let storedMessages = JSON.parse(localStorage.getItem(LOCAL_CHAT_KEY));
            if (storedMessages && storedMessages.length > 0) {
                storedMessages.forEach(msgData => {
                    const messageType = msgData.user === username ? 'my' : 'other'; 
                    addMessage(msgData, messageType);
                });
            }
        }
        
        // åœ¨èŠå¤©åˆ—è¡¨ä¸­æ˜¾ç¤ºæ¶ˆæ¯
        function addMessage(msgData, type) {
            const item = document.createElement('li');
            
            if (type === 'system') {
                item.className = 'system-msg';
                item.textContent = msgData.text;
            } else {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                
                const messageTime = msgData.timestamp ? new Date(msgData.timestamp) : new Date();
                const formattedTime = formatTime(messageTime);
                const senderName = msgData.user;

                const headerHtml = `
                    <div class="message-header">
                        <span class="username">${senderName === username ? 'æˆ‘' : senderName}</span>
                        <span class="timestamp">${formattedTime}</span>
                    </div>
                `;
                
                bubble.innerHTML = `${headerHtml}${msgData.text}`;
                item.appendChild(bubble);
                item.className = type === 'my' ? 'my-msg' : 'other-msg';
            }
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; 
            
            if (type !== 'system' && msgData.user) {
                saveMessageToLocal(msgData); // åªæœ‰éç³»ç»Ÿæ¶ˆæ¯æ‰ä¿å­˜
            }
        }
        
        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function updateOnlineList(users) {
            userList.innerHTML = '';
            userCountSpan.textContent = users.length;
            
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                userList.appendChild(li);
            });
        }


        // ------------------ çŠ¶æ€ç®¡ç† ------------------

        // å¤„ç†ç™»å½•æˆåŠŸåçš„åˆå§‹åŒ–
        function handleSuccessfulLogin() {
            authContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            currentUserDisplay.textContent = `ğŸ’¬ èŠå¤©å®¤ (${username})`;
            
            // 1. åŠ è½½æœ¬åœ°å†å²è®°å½•
            loadMessagesFromLocal();
            
            // 2. è¿æ¥ Socket.IO å¹¶æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            socket = io();
            
            // å‘Šè¯‰æœåŠ¡å™¨æˆ‘çš„æ˜µç§°
            socket.on('connect', () => {
                socket.emit('new user', username);
                addMessage({ text: `ä½ å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ˜µç§°ï¼š${username}` }, 'system');
            });
            
            // æ¥æ”¶å¹¶æ˜¾ç¤ºå®æ—¶èŠå¤©æ¶ˆæ¯ (ä¿®å¤å·¦å³å¯¹é½)
            socket.on('chat message', function(msgData) {
                if (msgData.user === username) { 
                    addMessage(msgData, 'my');
                } else {
                    addMessage(msgData, 'other');
                }
            });

            // æ¥æ”¶åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°
            socket.on('online users', updateOnlineList);

            // ä¸Šçº¿/ä¸‹çº¿é€šçŸ¥
            socket.on('user connected', (user) => addMessage({ text: `ğŸ“¢ ${user} å·²ä¸Šçº¿ã€‚` }, 'system'));
            socket.on('user disconnected', (user) => addMessage({ text: `âš ï¸ ${user} å·²ä¸‹çº¿ã€‚` }, 'system'));
            socket.on('disconnect', () => addMessage({ text: 'ğŸ”´ ä½ å·²æ–­å¼€è¿æ¥ã€‚' }, 'system'));
        }

        // ç™»å‡º/é€€å‡º
        logoutButton.addEventListener('click', () => {
            if (socket) {
                socket.disconnect(); // æ–­å¼€ Socket è¿æ¥
                socket = null;
            }
            localStorage.removeItem(USERNAME_KEY); // æ¸…é™¤æœ¬åœ°æ˜µç§°
            
            messages.innerHTML = ''; // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
            authContainer.style.display = 'block';
            chatContainer.style.display = 'none';
            
            usernameInput.value = '';
            username = '';
            updateOnlineList([]); // æ¸…ç©ºåœ¨çº¿åˆ—è¡¨
        });


        // ------------------ äº‹ä»¶ç›‘å¬ ------------------

        // æ˜µç§°è¾“å…¥è¡¨å•æäº¤ (ç®€å•ç™»å½•)
        authForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const inputName = usernameInput.value.trim();
            if (inputName) {
                username = inputName;
                localStorage.setItem(USERNAME_KEY, username);
                handleSuccessfulLogin();
            }
        });

        // èŠå¤©æ¶ˆæ¯å‘é€
        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const messageText = input.value.trim();
            if (messageText && socket) {
                // å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ä¼šè¡¥å…¨ user å’Œ timestamp
                socket.emit('chat message', { text: messageText });
                input.value = ''; 
            }
        });

        // é¡µé¢åŠ è½½æ—¶ï¼Œå°è¯•è‡ªåŠ¨ç™»å½•
        document.addEventListener('DOMContentLoaded', () => {
            const storedUsername = localStorage.getItem(USERNAME_KEY);
            if (storedUsername) {
                username = storedUsername;
                handleSuccessfulLogin(); // å¦‚æœæœ‰æ˜µç§°ï¼Œç›´æ¥è¿›å…¥èŠå¤©å®¤
            }
        });

    </script>
</body>
</html>