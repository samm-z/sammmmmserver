<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO èŠå¤©å®¤ - åŸºç¡€ç‰ˆ</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* ==================== CSS æ ·å¼ ==================== */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨æ¡å‡ºç° */
        }

        /* --- ç™»å½•ç•Œé¢ --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #login-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        #login-box input {
            padding: 12px;
            margin-bottom: 15px;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        #login-box input:focus {
            border-color: #007bff;
            outline: none;
        }

        #login-box button {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #login-box button:hover {
            background-color: #0056b3;
        }

        /* --- èŠå¤©ä¸»ç•Œé¢ --- */
        #chat-container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 250px;
            background-color: #e9ecef;
            padding: 15px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #sidebar h3 {
            margin-top: 0;
            color: #495057;
        }

        #online-users {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        #online-users li {
            padding: 8px 5px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }

        #online-users li:not(.user-self):hover {
            background-color: #d8e0e7;
        }

        .user-self {
            font-weight: bold;
            color: #28a745; 
        }
        
        .user-selected {
            background-color: #007bff !important;
            color: white;
            font-weight: bold;
        }

        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #fff;
            line-height: 1.6;
        }

        #message-form {
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
        }

        #message-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        #message-form button {
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #message-form button:hover {
            background-color: #1e7e34;
        }

        /* --- æ¶ˆæ¯æ ·å¼ --- */
        .message-item {
            margin-bottom: 10px;
        }

        .message-user {
            font-weight: bold;
            margin-right: 8px;
        }

        .system-message {
            text-align: center;
            color: #dc3545; /* ä½¿ç”¨çº¢è‰²è¡¨ç¤ºç³»ç»Ÿé€šçŸ¥ï¼Œæ›´é†’ç›® */
            font-style: italic;
            border-bottom: 1px dashed #ced4da;
            padding-bottom: 5px;
            margin-bottom: 15px !important;
        }

        .private-message .message-user, 
        .private-message .message-text {
            color: #dc3545; /* çº¢è‰²æ ‡è¯†ç§èŠ */
        }
        
        .private-tag {
            font-size: 0.8em;
            color: white;
            background-color: #dc3545;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>æ¬¢è¿åŠ å…¥èŠå¤©å®¤</h2>
            <input id="username-input" type="text" placeholder="è¾“å…¥ä½ çš„æ˜µç§°..." required>
            <button id="login-button">è¿›å…¥èŠå¤©</button>
            <p id="login-error" style="color: red; margin-top: 10px; min-height: 20px;"></p>
            <p id="socket-status" style="color: #6c757d; font-size: 0.9em;">ç­‰å¾…è¿æ¥æœåŠ¡å™¨...</p>
        </div>
    </div>

    <div id="chat-container" style="display: none;">
        
        <div id="sidebar">
            <h3 id="current-chat-title">å½“å‰ï¼šå…¬å…±èŠå¤©å®¤</h3>
            <p style="font-size: 0.9em; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                åœ¨çº¿ç”¨æˆ· (<span id="user-count">0</span>):
            </p>
            <ul id="online-users">
                </ul>
        </div>

        <div id="main-chat">
            <div id="messages">
                </div>
            <form id="message-form">
                <input id="message-input" autocomplete="off" placeholder="è¾“å…¥æ¶ˆæ¯..." required />
                <button type="submit">å‘é€</button>
            </form>
        </div>
    </div>

    <script>
        // å°è¯•è¿æ¥ Socket.IO
        const socket = io(); 
        let currentUsername = ''; // å½“å‰ç™»å½•çš„ç”¨æˆ·å
        let currentRecipient = null; // å½“å‰ç§èŠå¯¹è±¡ (null è¡¨ç¤ºå…¬å…±èŠå¤©)

        // DOM å…ƒç´ å¼•ç”¨
        const loginOverlay = document.getElementById('login-overlay');
        const loginButton = document.getElementById('login-button');
        const usernameInput = document.getElementById('username-input');
        const loginError = document.getElementById('login-error');
        const socketStatus = document.getElementById('socket-status');

        const chatContainer = document.getElementById('chat-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesDiv = document.getElementById('messages');
        const onlineUsersList = document.getElementById('online-users');
        const userCountSpan = document.getElementById('user-count');
        const currentChatTitle = document.getElementById('current-chat-title');


        // ==================== å®ç”¨å‡½æ•° ====================

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displayMessage(msg) {
            const item = document.createElement('div');
            item.classList.add('message-item');
            if (msg.isPrivate) {
                item.classList.add('private-message');
            }

            let userDisplay = msg.user;
            let textDisplay = msg.text;

            // 1. ç³»ç»Ÿæ¶ˆæ¯
            if (msg.user === 'system') {
                item.classList.add('system-message');
                item.innerHTML = textDisplay;
            } 
            // 2. æ­£å¸¸/ç§èŠæ¶ˆæ¯ (å®¢æˆ·ç«¯æ¶ˆæ¯è¿‡æ»¤é€»è¾‘)
            else {
                const isMyMsg = msg.user === currentUsername;
                const isRelevantToRecipient = currentRecipient === msg.user || currentRecipient === msg.recipient;
                
                // è¿‡æ»¤ä¸å±äºå½“å‰èŠå¤©çª—å£çš„æ¶ˆæ¯
                if (currentRecipient !== null && !isRelevantToRecipient && !isMyMsg) return; 
                if (currentRecipient === null && msg.isPrivate) return; 

                // ç§èŠæ ‡ç­¾
                let privateTag = '';
                if (msg.isPrivate) {
                    if (isMyMsg) {
                        userDisplay = 'ä½ ';
                        privateTag = `<span class="private-tag">ç§èŠç»™ ${msg.recipient}</span>`;
                    } else if (msg.recipient === currentUsername) {
                        privateTag = `<span class="private-tag">ç§èŠ</span>`;
                    }
                }
                
                item.innerHTML = `
                    <span class="message-user">${userDisplay}</span>
                    <span class="message-text">${textDisplay}</span>
                    ${privateTag}
                `;
            }

            messagesDiv.appendChild(item);
            scrollToBottom();
        }

        function displaySystemNotification(username, action) {
            const text = action === 'connected' ? 
                `ğŸŸ¢ **${username}** åŠ å…¥äº†èŠå¤©å®¤ã€‚` : 
                `ğŸ”´ **${username}** ç¦»å¼€äº†èŠå¤©å®¤ã€‚`;

            displayMessage({ user: 'system', text: text });
        }
        
        /**
         * è®¾ç½®å½“å‰çš„èŠå¤©å¯¹è±¡ (null ä¸ºå…¬å…±èŠå¤©)
         */
        function setRecipient(username) {
            if (username === currentUsername) return; // ä¸èƒ½ç§èŠè‡ªå·±
            currentRecipient = username;
            
            // 1. æ›´æ–°æ ‡é¢˜
            currentChatTitle.textContent = username ? 
                `å½“å‰ï¼šç§èŠ ${username}` : 
                'å½“å‰ï¼šå…¬å…±èŠå¤©å®¤';

            // 2. æ¸…ç©ºèŠå¤©è®°å½•å¹¶æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            messagesDiv.innerHTML = ''; 
            const statusText = username ? 
                `ğŸ’¬ ä½ æ­£åœ¨å’Œ **${username}** ç§èŠã€‚` : 
                `ğŸŒ ä½ å›åˆ°äº† **å…¬å…±èŠå¤©å®¤**ã€‚`;
            displayMessage({ user: 'system', text: statusText });

            // 3. æ›´æ–°ç”¨æˆ·åˆ—è¡¨é€‰ä¸­çŠ¶æ€ (æ‰‹åŠ¨æ›´æ–° DOM)
            const allUsersLi = onlineUsersList.querySelectorAll('li');
            allUsersLi.forEach(li => {
                li.classList.remove('user-selected');
                if (li.dataset.username === username || (username === null && li.textContent.includes('å…¬å…±èŠå¤©å®¤'))) {
                    li.classList.add('user-selected');
                }
            });
        }


        // ==================== ç™»å½•é€»è¾‘ ====================

        function attemptLogin() {
            const username = usernameInput.value.trim();
            loginError.textContent = '';
            if (username) {
                if (socket.connected) {
                    // å‘é€ 'new user' äº‹ä»¶åˆ°æœåŠ¡å™¨
                    socket.emit('new user', username);
                } else {
                    loginError.textContent = 'âŒ Socket æœªè¿æ¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
                }
            } else {
                loginError.textContent = 'âŒ æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼';
            }
        }

        loginButton.addEventListener('click', attemptLogin);

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });


        // ==================== æ¶ˆæ¯å‘é€é€»è¾‘ ====================

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            
            // è§†è§‰åé¦ˆï¼šç©ºæ¶ˆæ¯
            if (!text) {
                messageInput.focus(); 
                messageInput.style.backgroundColor = '#fff0f0';
                setTimeout(() => {
                    messageInput.style.backgroundColor = '#ffffff';
                }, 500);
                return;
            }

            const msgData = { text: text };

            if (currentRecipient) {
                // ç§èŠæ¨¡å¼
                msgData.recipient = currentRecipient;
                socket.emit('private message', msgData);
            } else {
                // å…¬å…±èŠå¤©æ¨¡å¼
                socket.emit('public message', msgData);
            }

            messageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        });

        // ==================== Socket.IO äº‹ä»¶ç›‘å¬ ====================

        // Socket è¿æ¥æˆåŠŸ
        socket.on('connect', () => {
            socketStatus.textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨ã€‚å¯ä»¥ç™»å½•äº†ã€‚';
            loginButton.disabled = false;
        });

        // Socket è¿æ¥å¤±è´¥æˆ–æ–­å¼€
        socket.on('disconnect', () => {
            socketStatus.textContent = 'ğŸ”´ å·²ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ã€‚';
            loginButton.disabled = true;
        });

        socket.on('connect_error', (err) => {
            console.error('è¿æ¥é”™è¯¯:', err.message);
            socketStatus.textContent = `âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥: ${err.message}`;
            loginButton.disabled = true;
        });


        // [1] æœåŠ¡å™¨æ¥å—ç™»å½•ï¼Œè¿›å…¥èŠå¤©å®¤ (è¿™æ˜¯ç™»å½•æˆåŠŸçš„å…³é”®å›è°ƒ)
        socket.on('user connected', (username) => {
            // åªæœ‰å½“æœåŠ¡å™¨ç¡®è®¤æ˜¯"æˆ‘"çš„è¿æ¥æ—¶ï¼Œæ‰åˆ‡æ¢ç•Œé¢
            if (username === usernameInput.value.trim() && !currentUsername) {
                currentUsername = username; // è®¾ç½®å½“å‰ç”¨æˆ·å
                loginOverlay.style.display = 'none'; // éšè—ç™»å½•ç•Œé¢
                chatContainer.style.display = 'flex'; // æ˜¾ç¤ºèŠå¤©ç•Œé¢
                displayMessage({ user: 'system', text: `âœ¨ æ¬¢è¿ï¼Œ**${username}**ï¼ä½ å·²æˆåŠŸè¿›å…¥èŠå¤©å®¤ã€‚` });
                messageInput.focus();
            } else if (username !== currentUsername) {
                // å…¶ä»–äººè¿æ¥çš„ç³»ç»Ÿé€šçŸ¥
                displaySystemNotification(username, 'connected');
            }
        });

        // [1] æ¥æ”¶ç³»ç»Ÿæ¶ˆæ¯ï¼ˆä¸»è¦ç”¨äºç™»å½•å¤±è´¥æˆ–ç§èŠå¤±è´¥çš„åé¦ˆï¼‰
        socket.on('system message', (msg) => {
            if (currentUsername) {
                // å·²ç™»å½•ï¼Œåœ¨èŠå¤©åŒºæ˜¾ç¤º
                displayMessage({ user: 'system', text: msg.text });
            } else {
                // æœªç™»å½•ï¼Œåœ¨ç™»å½•æ¡†æ˜¾ç¤ºé”™è¯¯
                loginError.textContent = msg.text;
            }
        });

        // [2] æ¥æ”¶å…¬å…±æ¶ˆæ¯
        socket.on('public message', (msgPayload) => {
            // isPrivate å­—æ®µåœ¨æœåŠ¡å™¨ç«¯æ²¡æœ‰è®¾ç½®ï¼Œä½†æˆ‘ä»¬çŸ¥é“å…¬å…±æ¶ˆæ¯ä¸æ˜¯ç§èŠ
            msgPayload.isPrivate = false; 
            displayMessage(msgPayload);
        });
        
        // [3] æ¥æ”¶ç§èŠæ¶ˆæ¯
        socket.on('private message', (msgPayload) => {
            msgPayload.isPrivate = true;
            displayMessage(msgPayload);
        });

        // [4] æ¥æ”¶ç”¨æˆ·æ–­å¼€è¿æ¥
        socket.on('user disconnected', (username) => {
            displaySystemNotification(username, 'disconnected');
            // å¦‚æœç§èŠå¯¹è±¡ä¸‹çº¿ï¼Œåˆ™åˆ‡æ¢å›å…¬å…±èŠå¤©
            if (currentRecipient === username) {
                setRecipient(null);
            }
        });

        // [5] æ¥æ”¶åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°
        socket.on('online users', (usernames) => {
            onlineUsersList.innerHTML = ''; 
            userCountSpan.textContent = usernames.length;

            // 1. æ·»åŠ å…¬å…±èŠå¤©é€‰é¡¹
            const publicLi = document.createElement('li');
            publicLi.textContent = 'ğŸŒ å…¬å…±èŠå¤©å®¤';
            publicLi.style.fontWeight = 'bold';
            publicLi.addEventListener('click', () => setRecipient(null));
            if (currentRecipient === null) {
                publicLi.classList.add('user-selected');
            }
            onlineUsersList.appendChild(publicLi);

            // 2. æ·»åŠ æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
            usernames.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                li.dataset.username = user;

                if (user === currentUsername) {
                    li.classList.add('user-self');
                    li.textContent += ' (æˆ‘)';
                } else {
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºç§èŠ
                    li.addEventListener('click', () => setRecipient(user));
                }
                
                // æ ‡è®°å½“å‰ç§èŠå¯¹è±¡
                if (user === currentRecipient) {
                    li.classList.add('user-selected');
                }

                onlineUsersList.appendChild(li);
            });
        });

    </script>
</body>
</html>
